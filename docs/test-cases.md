# План тестирования (Test Plan) - Fuel Tracker API

## 1. Введение

Этот документ описывает стратегию, объем, ресурсы и график запланированных мероприятий по тестированию REST API для проекта "Fuel Tracker". Цель тестирования — убедиться, что API соответствует функциональным и нефункциональным требованиям, изложенным в `docs/brd.md`, и готово к развертыванию в производственной среде.

## 2. Объем тестирования

### 2.1. Входит в объем (In Scope)

- **Тестирование API:** Основное внимание будет уделено тестированию REST API.
- **Функциональное тестирование:**
    - Аутентификация и авторизация (создание пользователя, вход, выход).
    - Управление профилем пользователя (настройки единиц измерения, валюты).
    - CRUD операции для транспортных средств (Vehicles).
    - CRUD операции для записей о заправках (Fuel Entries).
    - Корректность вычисляемых метрик (расход, стоимость и т.д.).
    - Валидация данных и обработка ошибок.
- **Тестирование безопасности:**
    - Изоляция данных пользователей (tenant isolation). Пользователь не может получить доступ к данным другого пользователя.
    - Проверка прав доступа к эндпоинтам.
- **Нагрузочное тестирование (базовое):**
    - Проверка времени ответа ключевых эндпоинтов под нагрузкой (согласно NFR 4.2).

### 2.2. Не входит в объем (Out of Scope)

- **Тестирование UI/Frontend:** Тестирование пользовательского интерфейса не проводится, так как в текущей задаче разрабатывается только backend.
- **Тестирование интеграции со сторонними сервисами:** В MVP нет внешних интеграций.
- **Юзабилити-тестирование.**
- **Тестирование совместимости (браузеры, ОС):** Неприменимо для API.

## 3. Стратегия тестирования

Тестирование будет проводиться преимущественно на уровне API с использованием инструментов для отправки HTTP-запросов (например, Postman, или написание интеграционных тестов на Python/Pytest).

- **Positive Testing:** Проверка того, что система корректно работает с валидными данными.
- **Negative Testing:** Проверка поведения системы на невалидные данные (неверный формат, пустые поля, нарушение бизнес-логики).
- **Boundary Value Analysis:** Тестирование граничных значений (например, максимальная длина строковых полей, нулевые значения для чисел).
- **Security Testing:** Попытки доступа к чужим данным путем подмены ID в запросах.

## 4. Критерии приемки

- 100% тестовых сценариев с приоритетом **High** должны быть пройдены.
- 95% тестовых сценариев с приоритетом **Medium** должны быть пройдены.
- Отсутствие блокирующих и критических дефектов.
- Время ответа API соответствует нефункциональным требованиям.

---

# Тестовая документация (Test Cases)

## 1. Аутентификация и Управление Аккаунтом (FR 3.1)

| ID | Title | Priority | Preconditions | Steps | Expected Result |
|---|---|---|---|---|---|
| **AUTH-001** | Успешная регистрация нового пользователя | High | Пользователя с `test@example.com` не существует. | 1. Отправить POST запрос на `/api/register` с валидными `email` и `password`. | 1. Статус код `201 Created`. <br> 2. В ответе содержится токен сессии. <br> 3. Пользователь создан в БД. |
| **AUTH-002** | Регистрация с уже существующим email | High | Пользователь с `test@example.com` уже существует. | 1. Отправить POST запрос на `/api/register` с `email="test@example.com"`. | 1. Статус код `400 Bad Request`. <br> 2. В ответе сообщение об ошибке, что email уже используется. |
| **AUTH-003** | Регистрация с невалидным паролем (короче 8 символов) | Medium | - | 1. Отправить POST запрос на `/api/register` с паролем "12345". | 1. Статус код `400 Bad Request`. <br> 2. В ответе сообщение о несоответствии пароля политике безопасности. |
| **AUTH-004** | Успешный вход в систему | High | Пользователь `test@example.com` существует и имеет пароль `password123`. | 1. Отправить POST запрос на `/api/login` с валидными `email` и `password`. | 1. Статус код `200 OK`. <br> 2. В ответе содержится токен сессии. |
| **AUTH-005** | Вход с неверным паролем | High | Пользователь `test@example.com` существует. | 1. Отправить POST запрос на `/api/login` с верным `email` и неверным `password`. | 1. Статус код `401 Unauthorized`. |
| **AUTH-006** | Выход из системы | High | Пользователь авторизован. | 1. Отправить POST запрос на `/api/logout` с валидным токеном сессии. | 1. Статус код `200 OK`. <br> 2. Сессия пользователя прекращена. Последующие запросы с этим токеном должны быть отклонены. |

## 2. Профиль пользователя и Настройки (FR 3.2)

| ID | Title | Priority | Preconditions | Steps | Expected Result |
|---|---|---|---|---|---|
| **PROF-001** | Получение профиля пользователя | High | Пользователь авторизован. | 1. Отправить GET запрос на `/api/profile`. | 1. Статус код `200 OK`. <br> 2. В ответе содержатся данные профиля: `displayName`, `currency`, `distanceUnit`, `volumeUnit`, `timeZone`. |
| **PROF-002** | Обновление настроек пользователя (единицы измерения) | High | Пользователь авторизован. | 1. Отправить PUT/PATCH запрос на `/api/profile` с `distanceUnit="mi"` и `volumeUnit="gal"`. | 1. Статус код `200 OK`. <br> 2. В ответе обновленные данные профиля. <br> 3. При последующем запросе GET `/api/profile` возвращаются новые значения. |
| **PROF-003** | Обновление настроек с невалидными значениями | Medium | Пользователь авторизован. | 1. Отправить PUT/PATCH запрос на `/api/profile` с `distanceUnit="invalid_unit"`. | 1. Статус код `400 Bad Request`. <br> 2. В ответе сообщение об ошибке валидации. |

## 3. Управление Транспортными Средствами (FR 3.3)

| ID | Title | Priority | Preconditions | Steps | Expected Result |
|---|---|---|---|---|---|
| **VEH-001** | Создание нового транспортного средства | High | Пользователь авторизован. | 1. Отправить POST запрос на `/api/vehicles` с валидными данными (обязательное поле `name`). | 1. Статус код `201 Created`. <br> 2. В ответе данные созданного ТС с присвоенным ID. |
| **VEH-002** | Создание ТС без обязательного поля `name` | High | Пользователь авторизован. | 1. Отправить POST запрос на `/api/vehicles` без поля `name`. | 1. Статус код `400 Bad Request`. <br> 2. Сообщение об ошибке валидации. |
| **VEH-003** | Получение списка ТС пользователя | High | Пользователь авторизован и имеет 2 созданных ТС. | 1. Отправить GET запрос на `/api/vehicles`. | 1. Статус код `200 OK`. <br> 2. В ответе массив из 2 объектов ТС. |
| **VEH-004** | Получение конкретного ТС по ID | High | Пользователь авторизован. ТС с ID=1 принадлежит ему. | 1. Отправить GET запрос на `/api/vehicles/1`. | 1. Статус код `200 OK`. <br> 2. В ответе данные ТС с ID=1. |
| **VEH-005** | Обновление данных ТС | High | Пользователь авторизован. ТС с ID=1 принадлежит ему. | 1. Отправить PUT/PATCH запрос на `/api/vehicles/1` с новым значением `name`. | 1. Статус код `200 OK`. <br> 2. В ответе обновленные данные ТС. |
| **VEH-006** | Удаление ТС | High | Пользователь авторизован. ТС с ID=1 принадлежит ему. | 1. Отправить DELETE запрос на `/api/vehicles/1`. | 1. Статус код `204 No Content`. <br> 2. ТС удалено из БД. |

## 4. Управление Записями о Заправках (FR 3.4)

| ID | Title | Priority | Preconditions | Steps | Expected Result |
|---|---|---|---|---|---|
| **FUEL-001** | Создание первой (базовой) записи о заправке | High | Пользователь авторизован. Существует ТС с ID=1. | 1. Отправить POST запрос на `/api/fuel-entries` с валидными данными (vehicleId=1, odometer=10000, date, etc.). | 1. Статус код `201 Created`. <br> 2. Запись создана. Вычисляемые поля (distance, consumption) должны быть `null`. |
| **FUEL-002** | Создание второй записи о заправке | High | Существует первая запись с odometer=10000. | 1. Отправить POST запрос на `/api/fuel-entries` с odometer=10200. | 1. Статус код `201 Created`. <br> 2. Запись создана. Вычисляемые поля корректно рассчитаны. |
| **FUEL-003** | Создание записи с одометром меньше предыдущего | High | Существует запись с odometer=10200. | 1. Отправить POST запрос на `/api/fuel-entries` с odometer=10100. | 1. Статус код `400 Bad Request`. <br> 2. Сообщение об ошибке "Odometer value must be greater than the previous entry". |
| **FUEL-004** | Создание записи с датой в будущем | Medium | - | 1. Отправить POST запрос с датой, которая позже текущей. | 1. Статус код `400 Bad Request`. <br> 2. Сообщение об ошибке валидации даты. |
| **FUEL-005** | Редактирование записи о заправке | High | Существует запись с ID=1. | 1. Отправить PUT/PATCH запрос на `/api/fuel-entries/1` с измененными данными. | 1. Статус код `200 OK`. <br> 2. Запись обновлена. Связанные метрики (у этой и следующей записи) пересчитаны. |
| **FUEL-006** | Удаление записи о заправке | High | Существуют 3 записи (ID 1, 2, 3). | 1. Отправить DELETE запрос на `/api/fuel-entries/2`. | 1. Статус код `204 No Content`. <br> 2. Запись удалена. Метрики для записи ID=3 пересчитаны, используя данные записи ID=1. |
| **FUEL-007** | Получение списка записей с пагинацией | Medium | Создано 30 записей о заправках. | 1. Отправить GET запрос на `/api/fuel-entries?page=1&size=25`. | 1. Статус код `200 OK`. <br> 2. В ответе массив из 25 записей, отсортированных по дате (desc). |

## 5. Безопасность и Изоляция Данных (NFR 4.1)

| ID | Title | Priority | Preconditions | Steps | Expected Result |
|---|---|---|---|---|---|
| **SEC-001** | Попытка получить ТС другого пользователя | Critical | Пользователь A (ID=1) авторизован. <br> ТС с ID=10 принадлежит пользователю B (ID=2). | 1. Отправить GET запрос на `/api/vehicles/10` от имени пользователя A. | 1. Статус код `404 Not Found`. |
| **SEC-002** | Попытка обновить запись о заправке другого пользователя | Critical | Пользователь A авторизован. <br> Запись с ID=20 принадлежит пользователю B. | 1. Отправить PUT/PATCH запрос на `/api/fuel-entries/20` от имени пользователя A. | 1. Статус код `404 Not Found`. |
| **SEC-003** | Попытка удалить ТС другого пользователя | Critical | Пользователь A авторизован. <br> ТС с ID=10 принадлежит пользователю B. | 1. Отправить DELETE запрос на `/api/vehicles/10` от имени пользователя A. | 1. Статус код `404 Not Found`. |
| **SEC-004** | Доступ к эндпоинтам без авторизации | High | Пользователь не авторизован. | 1. Отправить GET запрос на `/api/vehicles`. | 1. Статус код `401 Unauthorized`. |
